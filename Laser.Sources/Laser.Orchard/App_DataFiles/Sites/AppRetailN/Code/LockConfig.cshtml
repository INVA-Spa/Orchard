@using Orchard.ContentManagement;
@using Laser.Orchard.HiddenFields.Fields;
@using System.Linq;

@functions{
    // Model.ContentItem is a MessaggioPromozionale
    string retString = "Error"; //possible outcomes: Error,ConfigurazioneGrafica,ConfigurazioneAppStore
    string eMsg = "";
    //services
    IContentManager _contentManager;
}
@{
    try {
        // resolve services
        _contentManager = Model.OrchardServices.WorkContext.Resolve<IContentManager>();
        // get config
        ContentItem config = Model.ContentItem;
        string contentType = config.ContentType;
        ContentPart part = config.Parts.FirstOrDefault(x => x.PartDefinition.Name == contentType);
        if(part != null) {
            ContentField field = part.Fields.FirstOrDefault(x => x.Name == "ConfigStatus");
            if(field != null) {
                HiddenStringField hidden = field as HiddenStringField;
                if (string.IsNullOrWhiteSpace(hidden.Value)) {
                    hidden.Value = "locked";
                    _contentManager.Publish(config);
                } else {
                    // annullo la versione corrente
                    config.VersionRecord.Published = false;
                    ContentItem previous = _contentManager.Get(config.Id, VersionOptions.Latest);
                    previous.VersionRecord.Published = true;
                }
            }
        }
        retString = contentType;
    } catch (Exception ex) {
        eMsg += string.Format("\r\n{0}", ex.Message);
        Model.Tokens["Workflow"].SetState("ErrorMessage", eMsg);
    }
}@retString