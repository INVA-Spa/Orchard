@using Orchard.ContentManagement;
@using System.Linq;

@functions{
    // Model.ContentItem is a MessaggioPromozionale
    // If no PuntoVendita is associated with this MessaggioPromozionale, it associates all PuntoVendita items.
    string retString = "Error"; //possible outcomes: Error,Ok
    string eMsg = "";
    //services
    IContentManager _contentManager;
    // methods
    private int[] GetIdPuntiVendita() {
        var puntiVenditaList = _contentManager.Query("PuntoVendita").List().Select(x => x.Id);
        return puntiVenditaList.ToArray();
    }
}
@{
    try {
        // resolve services
        _contentManager = Model.OrchardServices.WorkContext.Resolve<IContentManager>();
        // get promo
        dynamic promo = Model.ContentItem;
        if(promo.MessaggioPromozionale.PuntoVendita.Ids.Length == 0) {
            promo.MessaggioPromozionale.PuntoVendita.Ids = GetIdPuntiVendita();
        }
        retString = "Ok";
    } catch (Exception ex) {
        eMsg += string.Format("\r\n{0}", ex.Message);
        Model.Tokens["Workflow"].SetState("ErrorMessage", eMsg);
    }
}@retString