@using Orchard;
@using Orchard.ContentManagement;
@using Orchard.Projections.Services;
@using Orchard.Security;
@using Orchard.Users.Models;
@using Orchard.Users.Services;
@using System.Text.RegularExpressions;
@using System.Web.Security;
@using System.Text;
@using System.Globalization;
@using System.Collections.Generic;
@using Laser.Orchard.StartupConfig.Handlers;
@using Laser.Orchard.CommunicationGateway.Models;
@using Laser.Orchard.CommunicationGateway.Services;

@functions{
    IMembershipService _membershipService;
}
@{
    _membershipService = Model.OrchardServices.WorkContext.Resolve<IMembershipService>();
	ICommunicationService _communicationService = Model.OrchardServices.WorkContext.Resolve<ICommunicationService>();
    string retString = "OK";
    try {
        dynamic item = Model.ContentItem;
        if ((!(bool)(item.ProfilePart.AppDownloaded.Value ?? false)) && (!string.IsNullOrEmpty( Model.OrchardServices.WorkContext.HttpContext.Request.Headers["x-UUID"]))) {
            item.ProfilePart.AppDownloaded.Value = true;
			_communicationService.UserToContact((IUser)(_membershipService.GetUser(item.User.UserPart.UserName).UserPart));
        }
        retString = "OK";
    } catch (Exception ex) {
        retString = "Error";
        string eMsg = string.Format("\r\n{0}", ex.Message);
        Model.Tokens["Workflow"].SetState("ErrorMessage", eMsg);
    }
}@retString