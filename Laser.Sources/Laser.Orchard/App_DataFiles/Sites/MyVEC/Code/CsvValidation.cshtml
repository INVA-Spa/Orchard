@using System.ComponentModel.DataAnnotations;
@using System.Globalization;
@using Orchard.UI.Notify;
@using Orchard.Localization;
@{ 
    // possible outcomes: Error, OK
    // if OK, set {Workflow.State.InvitationNumber} to the number of invitation in CSV
    // email;cognome;nome;azienda;prenotabile(SI||NO);tornelli(SI||NO)
    // the sixth field is optional
    try {
        var T = NullLocalizer.Instance;
        bool validatecsv = true;
        int maxnotiermessage = 3;
        var testerEmail = new EmailAddressAttribute();
        var _notifier = Model.OrchardServices.WorkContext.Resolve<INotifier>();
        string error = "";
        dynamic item = Model.ContentItem;
        string csv = item.Visita.CSVlistaInvitati.Value;
        string[] rowSeparator = new string[] { "\r\n", "\r", "\n" };
        var allLines = csv.Split(rowSeparator, StringSplitOptions.RemoveEmptyEntries);
        var numline = 0;
        int messagenotified = 0;
        foreach (string line in allLines) {
            if (messagenotified <= maxnotiermessage) {
                numline++;
                var fields = line.Split(';');
                if (fields.Length < 5 || fields.Length > 8) { //testo che ci siano tutti i campi
                    validatecsv = false;
                    messagenotified++;
                    _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": previsti da 5 a 8 campi"));
                }
                else {
                    if (!testerEmail.IsValid(fields[0])) {
                        validatecsv = false;
                        messagenotified++;
                        _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": Email non valida"));
                    }
                    if (string.IsNullOrEmpty(fields[1])) {
                        validatecsv = false;
                        messagenotified++;
                        _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": Cognome obbligatorio"));
                    }
                    if (string.IsNullOrEmpty(fields[2])) {
                        validatecsv = false;
                        messagenotified++;
                        _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": Nome obbligatorio"));
                    }
                    if (string.IsNullOrEmpty(fields[4]) || (fields[4].ToUpper() != "SI" && fields[4].ToUpper() != "NO")) {
                        validatecsv = false;
                        messagenotified++;
                        _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": campo obbligatorio, valori consentiti, SI o NO"));
                    }
                    if (fields.Length > 5) { //test the tornelli field
                        if (fields[5].ToUpper() != "SI" && fields[5].ToUpper() != "NO") {
                            validatecsv = false;
                            messagenotified++;
                            _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": valori consentiti per abilitazione tornelli, SI o NO"));
                        }
                    }
                    if (fields.Length > 6) { //test the birth date field
                        DateTime dt = DateTime.Now;
                        if(DateTime.TryParseExact(fields[6], "dd/MM/yyyy", CultureInfo.InvariantCulture, DateTimeStyles.None, out dt) == false) {
                            validatecsv = false;
                            messagenotified++;
                            _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": la data di nascita deve essere nel formato gg/MM/aaaa"));
                        }
                    }
                    if (fields.Length > 7) { //test the sex field
                        if (fields[7].ToUpper() != "M" && fields[7].ToUpper() != "F") {
                            validatecsv = false;
                            messagenotified++;
                            _notifier.Add(NotifyType.Error, T("linea " + numline.ToString() + ": valori consentiti per sesso, M o F"));
                        }
                    }
                }
            }
        }
        if (validatecsv) {
            var wfContext = Model.Tokens["Workflow"];
            wfContext.SetState("InvitationNumber", numline);
            WriteLiteral("OK");
        }
        else {
            WriteLiteral("Error");
        }
    }
    catch (Exception ex) {
        WriteLiteral("Error");
    }
}