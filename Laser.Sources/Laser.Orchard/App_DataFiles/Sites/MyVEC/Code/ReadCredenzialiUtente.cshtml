@using Orchard;
@using Orchard.Security;
@using Orchard.ContentManagement;
@using Orchard.ContentManagement.Records;
@using Orchard.Data;
@using Orchard.Localization.Services;
@using System.Linq;
@using Newtonsoft.Json.Linq;
@functions{
    string retString = "Error"; //possible outcomes: "Error","OK"
    IContentManager _contentManager = null;
    IEncryptionService _encryptionService = null;
    IMembershipService _membershipService = null;
    ILocalizationService _localizationService = null;
    Orchard.Workflows.Models.WorkflowContext wfContext = null;
}
@{
    try {
        wfContext = Model.Tokens["Workflow"];
        //Resolve services
        _contentManager = Model.OrchardServices.WorkContext.Resolve<IContentManager>();
        _encryptionService = Model.OrchardServices.WorkContext.Resolve<IEncryptionService>();
        _membershipService = Model.OrchardServices.WorkContext.Resolve<IMembershipService>();
        _localizationService = Model.OrchardServices.WorkContext.Resolve<ILocalizationService>();

        ContentItem ciUsr = _contentManager.Get((int)(@Model.ContentItem.CommonPart.Creator.Value));
        dynamic usr = (dynamic)ciUsr;
        string userName = usr.UserPart.UserName;
        string pwd = "";
        string encodedPwd = usr.User.OriginalPassword.Value ?? "";
        if(string.IsNullOrWhiteSpace(encodedPwd) == false) {
            byte[] bEncodedPwd = Convert.FromBase64String(encodedPwd);
            pwd = System.Text.Encoding.Unicode.GetString(_encryptionService.Decode(bEncodedPwd));
            // verify pwd
            if(_membershipService.ValidateUser(userName, pwd) == null) {
                pwd = "";
            }
        }
        // save informations in workflow State
        wfContext.SetState("UserName", userName);
        wfContext.SetState("Password", pwd);
        // calculate custom template id relaying on the fact that this workflow contains only one activity of type SendTemplatedEmail
        var customTemplateId = "";
        var activity = wfContext.Record.WorkflowDefinitionRecord.ActivityRecords.FirstOrDefault(x => x.Name == "SendTemplatedEmail"
            && x.State.Contains("\"RecipientOther\":\"{Content.CreatorEmail}\"")
            && x.State.Contains("\"Recipient\":\"other\""));
        if (activity != null) {
            var state = JObject.Parse(activity.State);
            var templateId = Convert.ToInt32(state["EmailTemplate"]);
            var templateCi = _contentManager.Get(templateId);
            var localizationPart = _localizationService.GetLocalizedContentItem(templateCi, usr.FavoriteCulturePart.Culture);
            customTemplateId = Convert.ToString(localizationPart.Id);
        }
        wfContext.SetState("CustomTemplateId", customTemplateId);
        wfContext.SetState("Email", usr.UserPart.Email);
        retString = "OK";
    }
    catch (Exception ex) {
        wfContext.SetState("ErrorMessage", ex.Message);
    }
}
@retString