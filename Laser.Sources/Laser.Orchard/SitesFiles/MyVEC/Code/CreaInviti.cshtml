@using Orchard;
@using Orchard.ContentManagement;
@using Orchard.Data;
@using System.Linq;
@functions{
    string retString = "Error"; //possible outcomes: "Error","Ok"
    dynamic visita = null;
    string csv = "";
    string[] rowSeparator = new string[] { "\r\n", "\r", "\n" };
    string[] fieldSeparator = new string[] { ",", ";" };
    dynamic invito = null;
}
@{
    visita = Model.ContentItem;
    string visitaId = string.Format("{{{0}}}", visita.Id);
    // legge il csv con gli invivati
    csv = visita.Visita.CSVlistaInvitati.Value;
    var rows = csv.Split(rowSeparator, StringSplitOptions.RemoveEmptyEntries);
    foreach(var row in rows) {
        string[] fields = row.Split(fieldSeparator, StringSplitOptions.None);
        invito = null;
        if(fields.Length > 0) {
            // email
            invito = Model.OrchardServices.ContentManager.New("SchedaInvito");
            Model.OrchardServices.ContentManager.Create(invito);
            invito = Model.OrchardServices.ContentManager.Get(invito.Id);
            invito.SchedaInvito.Visita.Ids = new int[] { visita.Id };
            invito.SchedaInvito.Email.Value = fields[0];
            invito.TitlePart.Title = "";
            invito.ActivityPart.DateTimeStart = visita.ActivityPart.DateTimeStart;
            invito.ActivityPart.DateTimeEnd = visita.ActivityPart.DateTimeEnd;
            invito.ActivityPart.AllDay = visita.ActivityPart.AllDay;
        }
        if (fields.Length > 1) {
            // cognome
            invito.SchedaInvito.Cognome.Value = fields[1];
            invito.TitlePart.Title += fields[1];
        }
        if (fields.Length > 2) {
            // nome
            invito.SchedaInvito.Nome.Value = fields[2];
            invito.TitlePart.Title += " " + fields[2];
        }
        if (fields.Length > 3) {
            // azienda
            invito.SchedaInvito.Azienda.Value = fields[3];
        }
        if(invito != null) {
            invito.TitlePart.Title += " - " + visita.TitlePart.Title;
        }
    }
    retString = "Ok";
}
@retString