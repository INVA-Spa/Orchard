@using Orchard;
@using Orchard.Users.Models;
@using Orchard.ContentManagement.Records;
@using Orchard.Projections.Models;
@using Orchard.Projections.Services;
@using Orchard.Data;
@using System.Linq;
@using Orchard.Security;
@using Orchard.ContentManagement;
@using Laser.Orchard.StartupConfig.Handlers;

@functions{
    IFieldIndexService _fieldIndexService;
    IContentManager _contentManager;
    IMembershipService _membershipService;
    IContactRelatedEventHandler _contactEventHandler;
    string retString = "Error"; //possible outcomes: "Error","Ok"
    dynamic invito = null;
    dynamic prenotazione = null;
    Orchard.Workflows.Models.WorkflowContext wfCtx = null;
}
@{
    try {
   
        wfCtx = Model.Tokens["Workflow"];
        _fieldIndexService = Model.OrchardServices.WorkContext.Resolve<IFieldIndexService>();
        invito = Model.ContentItem;
        _contentManager = Model.OrchardServices.WorkContext.Resolve<IContentManager>();
        _contactEventHandler = Model.OrchardServices.WorkContext.Resolve<IContactRelatedEventHandler>();
        _membershipService = Model.OrchardServices.WorkContext.Resolve<IMembershipService>();
        int iduser = (int)invito.CommonPart.Creator.Value;
        dynamic RelatedUser = _contentManager.Get(iduser);
        IUser kUser = _membershipService.GetUser((string)RelatedUser.UserPart.UserName);
        dynamic dUser = kUser;
        string targa = Convert.ToString(wfCtx.GetState("Targa"));
        if (targa==""){
             if ((((int[])(dUser.User.ProfilePart.ReservedParking.Ids)).Contains((int)invito.Id)) ){
                 int[] val = ((int[])(dUser.ProfilePart.ReservedParking.Ids)).Where(xz=>xz != (int)invito.Id).ToArray();
                 dUser.ProfilePart.ReservedParking.Ids = val;
                 _contactEventHandler.Synchronize(dUser);
             }
        }
        else{
            if (!(((int[])(dUser.User.ProfilePart.ReservedParking.Ids)).Contains((int)invito.Id)) ){
                int[] val = ((int[])(dUser.ProfilePart.ReservedParking.Ids)).Concat(new int[] { (int)invito.Id }).ToArray();
                dUser.ProfilePart.ReservedParking.Ids = val;
                _contactEventHandler.Synchronize(dUser);
            }
       }
        
       
        if(invito.SchedaInvito.Prenotazioneparcheggio.Ids.Length == 0) {
            // crea nuova prenotazione
            prenotazione = Model.OrchardServices.ContentManager.New("Prenotazioneparcheggio");
            Model.OrchardServices.ContentManager.Create(prenotazione);
            prenotazione = Model.OrchardServices.ContentManager.Get(prenotazione.Id);
            string codPrenotazione = string.Format("PARK00{0}", invito.Id);
            
            prenotazione.Prenotazioneparcheggio.IDPrenotazione.Value = codPrenotazione;
            _fieldIndexService.Set(
                prenotazione.FieldIndexPart,
                "Prenotazioneparcheggio",
                "IDPrenotazione",
                "",
                codPrenotazione,
                typeof(string)
            );
            invito.SchedaInvito.Prenotazioneparcheggio.Ids = new int[] { prenotazione.Id };
            _fieldIndexService.Set(
                invito.FieldIndexPart,
                "SchedaInvito",
                "Prenotazioneparcheggio",
                "",
                string.Format("{{{0}}}", prenotazione.Id),
                typeof(string)
            );
        }
        else {
            // recupera prenotazione esistente
            prenotazione = Model.OrchardServices.ContentManager.Get(invito.SchedaInvito.Prenotazioneparcheggio.Ids[0]);
        }
       
        // aggiorna la targa
        prenotazione.Prenotazioneparcheggio.Targa.Value = targa;
        _fieldIndexService.Set(
            prenotazione.FieldIndexPart,
            "Prenotazioneparcheggio",
            "Targa",
            "",
            targa,
            typeof(string)
        );
        // aggiorna le date
        prenotazione.ActivityPart.DateTimeStart = invito.ActivityPart.DateTimeStart;
        prenotazione.ActivityPart.DateTimeEnd = invito.ActivityPart.DateTimeEnd;
        prenotazione.ActivityPart.AllDay = invito.ActivityPart.AllDay;
        Model.OrchardServices.ContentManager.Publish(prenotazione);
        // aggiunge il codice prenotazione allo state del workflow
        wfCtx.SetState("CodPrenotazioneParcheggio", prenotazione.Prenotazioneparcheggio.IDPrenotazione.Value);
        retString = "Ok";
    }
    catch(Exception ex) {
        wfCtx.SetState("ErrorMessage", ex.Message);
    }
}
@retString